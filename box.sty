%% 박스, 틀, 테두리 등 시각적 요소 정의
%% 박스 스타일 정의 - 패키지 불러와야 newtcolorbox 쓸 수 있음

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 공통 스타일 정의
% 박스 공통 스타일
\tcbset{boxbase/.style={
  boxrule=1pt, arc=1mm,% 테두리선 두께, 둥근 모서리 반경
  top=4pt, bottom=4pt, left=4pt, right=4pt,% 상하좌우 여백
  colback=white,% 추가 입력 안할 시 본문 배경은 흰색
  before upper={% 박스 내부 여백 설정
  \setlength{\lineskiplimit}{2pt}% 인라인 위아래 간격이 임계값보다 작으면
  \setlength{\lineskip}{5pt}% 추가 간격 확보(수식 입력 등에 유용함)
  \setlength{\abovedisplayskip}{5pt}% 일반적인 디스플레이 수식 여백 설정
  \setlength{\belowdisplayskip}{5pt}
  \setlength{\abovedisplayshortskip}{5pt}% 특수상황(수식 앞줄이 짧게 끝나는 경우)
  \setlength{\belowdisplayshortskip}{5pt}}}}% 특수상황(수식 아랫줄이 짧게 끝나는 경우)

% 박스 제목 있는 경우 위아래 여백 미리 확보 - 수직이동량, 위쪽여백, 아래쪽여백, 내용으로 선언
\newcommand{\boxtitle}[1]{\raisebox{0pt}[9pt][2pt]{#1}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 기본 단순박스 제작
% 회색 박스 (설명, 정리 등)
\newtcolorbox{graybox}{boxbase,% 공통 서식 먼저 호출
  colframe=gray!50}% 테두리(기본 제목 배경) - 회색(50%)
% 강조용 빨간 테두리 박스
\newtcolorbox{redbox}{boxbase,
  colframe=red}% 테두리(기본 제목 배경) - 빨간색
% 강조용 파란 배경 박스
\newtcolorbox{bluebox}{boxbase,
  colback=blue!5,% 본문 배경 - 파란색(5%)
  colframe=blue!50}% 테두리(기본 제목 배경) - 중간 파랑
% 회색 수식 박스 - graybox에 수식 정렬만 추가
\newtcolorbox{eqbox}{boxbase,
  ams align,% 수식 정렬
  colback=gray!10,% 본문 배경 - 회색(10%)
  colframe=gray!50}% 테두리(기본 제목 배경) - 회색(50%)


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 좌우 양면 박스
\newtcolorbox{doublebox}[4]{boxbase,
  colframe=gray!50,% 테두리(기본 제목 배경) - 회색(50%)
  enhanced,% 내부 LaTeX 코드 허용
  before upper={%
  \begingroup% 캡션 설정 여기서만 적용되도록 로컬화함
    \captionsetup[figure]{width=\linewidth}% 박스 안에서만 글너비에 꽉차도록 함
    \captionsetup[table]{width=\linewidth}% 표 캡션도 마찬가지
    \begin{minipage}[t]{#1\linewidth}% 왼쪽 폭, t로 위부터 쌓이게 함
      #3% 왼쪽 내용
    \end{minipage} \hfill% 끝까지 밀어내기
    \begin{minipage}[t]{#2\linewidth}% 오른쪽 폭
      #4% 오른쪽 내용
    \end{minipage}\endgroup
    \par\addvspace{0.6\medskipamount}},% 아래 새로운 본문이 시작될 때만 간격 벌리기
  after upper={}}% 추가 명령어 없음

% 박스 내부에서 쓰도록 doublepage를 쉽게 만듦, 여백이나 간격을 제거하여 본문과 똑같이 쓰이게 함
\NewDocumentEnvironment{doublepage}{mm +m +m}{% 빈 줄 허용
  \parindent=0pt\parskip=0pt%
  \leavevmode\noindent%
  \captionsetup[figure]{width=\linewidth}%
  \captionsetup[table]{width=\linewidth}%
  \begin{minipage}[t]{#1\linewidth}%
    #3%
  \end{minipage}%
  \hfill%
  \begin{minipage}[t]{#2\linewidth}%
    #4%
  \end{minipage}%
}{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 보충설명용 박스 제작
%% sssbox 정의
\NewTColorBox{sssbox}{g}{boxbase,% 제목을 {}안에 넣으면 제목이 함께 출력됨
  title={\boxtitle{\IfNoValueTF{#1}{Sss...}{Sss... \,\,#1}}},
  colframe=black,% 테두리(기본 제목 배경) - 검정
  colbacktitle=white,% 제목 배경 변경 - 흰색
  coltitle=black}% 제목 글씨색 - 검정

% {g}는 입력하지 않을 경우 아예 없는 것으로 판단함. 즉 괄호 자체가 없음
% {O{} g}는 입력하지 않으면 공백을 입력한 것으로 판단함. 즉 빈괄호{}를 생성함


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 문제풀이용 박스 제작
% check, practice, question, problem의 4단계 문제
% ckbox, ptbox, qubox, ptbox로 제작

% solution의 문제 해결 박스는
% 1번 모드면 본문에 나와서 보면서 편집이 가능하고,
% 2번 모드이면 .sol 파일에 저장되어 나중에 한 번에 불러올 수 있도록 함
% 3번 모드이면(맨 뒤 문제풀이용) seolmode 1,2에서는 자리차지하고 안보임

% 1. 넘버링
% section 기준으로 리셋
% 번호 형식은 '챕터.섹션.누적번호'임 (예: 18.1.1)
\newcounter{ckbox}[section]
\renewcommand{\theckbox}{\arabic{chapter}.\arabic{section}.\arabic{ckbox}}

\newcounter{ckboxstar}[section]% star(*)는 seolmode 2까지는 번호가 안보임. 3부터 관리용으로 보임
\renewcommand{\theckboxstar}{\arabic{chapter}.\arabic{section}.\arabic{ckboxstar}}

\newcounter{ptbox}[section]
\renewcommand{\theptbox}{\arabic{chapter}.\arabic{section}.\arabic{ptbox}}

\newcounter{ptboxstar}[section]
\renewcommand{\theptboxstar}{\arabic{chapter}.\arabic{section}.\arabic{ptboxstar}}

% 2. 마지막으로 사용된 문제의 정보 저장(솔루션 박스 자동 매치를 위함)
\newcommand{\lastboxtype}{}
\newcommand{\lastboxno}{}

% 2. 문제박스 출력
\NewTColorBox{ckboxbox}{g}{boxbase,% 제목을 {}안에 넣으면 제목이 함께 출력됨, 공통 서식 호출
  title={\boxtitle{check\,\,\theckbox\IfNoValueF{#1}{. \,\,#1}}},
  colframe=gray!50,% 테두리(기본 제목 배경) - 회색(50%)
  coltitle=black}% 제목 글씨색 - 검정
\NewDocumentEnvironment{ckbox}{g}{
  \refstepcounter{ckbox}%
  \xdef\lastboxtype{check}%
  \xdef\lastboxno{\theckbox}%
  \begin{ckboxbox}{#1}}{\end{ckboxbox}}

\NewTColorBox{ckboxbox*}{g}{boxbase,% 제목을 {}안에 넣으면 제목이 함께 출력됨, 공통 서식 호출
  title={\boxtitle{check% 기본 텍스트
    \ifnum\seolmode>2%
    \,(**)\,\theckboxstar\IfNoValueF{#1}% 모드 3,4일 때 번호 강제 출력, 제목 있으면 점 찍고 출력
    \fi\IfNoValueF{#1}{. \,\,#1}}},% 제목이 있으면 점을 찍고 제목 출력
  colframe=gray!50,% 테두리(기본 제목 배경) - 회색(50%)
  coltitle=black}% 제목 글씨색 - 검정
\NewDocumentEnvironment{ckbox*}{g}{
  \refstepcounter{ckboxstar}%
  \xdef\lastboxtype{check (**)}%
  \xdef\lastboxno{\theckboxstar}%
  \begin{ckboxbox*}{#1}}{\end{ckboxbox*}}

\NewTColorBox{ptboxbox}{g}{boxbase,% 제목을 {}안에 넣으면 제목이 함께 출력됨, 공통 서식 호출
  title={\boxtitle{practice\,\,\theptbox\IfNoValueF{#1}{. \,\,#1}}},
  colframe=black,% 테두리(기본 제목 배경) - 검정
  coltitle=white}% 제목 글씨색 - 흰색
\NewDocumentEnvironment{ptbox}{g}{
  \refstepcounter{ptbox}%
  \xdef\lastboxtype{practice}%
  \xdef\lastboxno{\theptbox}%
  \begin{ptboxbox}{#1}}{\end{ptboxbox}}

\NewTColorBox{ptboxbox*}{g}{boxbase,% 제목을 {}안에 넣으면 제목이 함께 출력됨, 공통 서식 호출
  title={\boxtitle{practice% 기본 텍스트
    \ifnum\seolmode>2%
    \,(**)\,\theptboxstar\IfNoValueF{#1}% 모드 3,4일 때 번호 강제 출력, 제목 있으면 점 찍고 출력
    \fi\IfNoValueF{#1}{. \,\,#1}}},% 제목이 있으면 점을 찍고 제목 출력
  colframe=black,% 테두리(기본 제목 배경) - 검정
  coltitle=white}% 제목 글씨색 - 흰색
\NewDocumentEnvironment{ptbox*}{g}{
  \refstepcounter{ptboxstar}%
  \xdef\lastboxtype{practice (**)}%
  \xdef\lastboxno{\theptboxstar}%
  \begin{ptboxbox*}{#1}}{\end{ptboxbox*}}

% 3-1. 솔루션 박스(제목은 날리고 번호만 가져옴)
% 1은 본문 출력과 파일 저장 / 2는 파일 저장만 / 3일 때는 seolmode에 따라 동작
\NewTColorBox{solprintbox}{m m g}{boxbase,
  title={\boxtitle{sol:\,\,#1\,\,#2}},
  colframe=blue!50,% 중간 파란 테두리
  coltitle=black,% 제목 글씨색
  colbacktitle=white}% 제목 배경색

% 하얀 출력 박스(자리 차지용)
\NewTColorBox{solprintboxwhite}{m m g}{boxbase,
  title={\boxtitle{\textcolor{white}{sol:\,\,#1\,\,#2}}},
  colframe=white,coltitle=white,colbacktitle=white}

% 3-2. .sol.tmp 파일 생성 (main 폴더에 생성)
\newwrite\solfile
\newif\ifsolopen
\solopenfalse
\newcommand{\SolOpenFile}{%
  \ifsolopen\else
    \immediate\openout\solfile=solution.sol.tmp\relax
    \global\solopentrue\fi}
\AtEndDocument{%
  \ifsolopen
    \immediate\closeout\solfile\fi}

% 3-3. 모드별 동작
% 자동추적 변수로 \lastboxtype, \lastboxno 사용
\newcommand{\SolSetGraphicsPath}[1]{\graphicspath{{#1}{#1figures/}}}% 그림 경로 바뀌는 것 방지
\NewDocumentEnvironment{solbox}{m g +b}{%1,2일때만 파일 저장
  \ifnum#1<3\relax
    \SolOpenFile
    \begingroup
      \edef\__soldir{\currfiledir}%
      \immediate\write\solfile{%
        \string\begingroup
        \string\SolSetGraphicsPath{\__soldir}%
        \string\begin{solprintbox}{\lastboxtype}{\lastboxno}{}}%
      \immediate\write\solfile{\unexpanded{#3}}%
      \immediate\write\solfile{%
        \string\end{solprintbox}%
        \string\endgroup}%
    \endgroup\fi
  \ifnum#1=1\relax% 1. 본문 출력 + 파일저장
    \begin{solprintbox}{\lastboxtype}{\lastboxno}{}
      #3
    \end{solprintbox}
  \else\ifnum#1=3\relax% 3. seolmode에 따라 출력/화이트 자리 차지
    \ifnum\seolmode>2\relax
      \begin{solprintbox}{\lastboxtype}{\lastboxno}{}
        #3\end{solprintbox}
    \else
      \begin{solprintboxwhite}{\lastboxtype}{\lastboxno}{}
        #3\end{solprintboxwhite}\fi\fi\fi}{}

%% questionbox 정의
\NewTColorBox{questionboxbox}{g}{boxbase,
  title={\boxtitle{question\IfNoValueF{#1}{. \,\,#1}}},
  colframe=gray!50,% 테두리(기본 제목 배경) - 회색(50%)
  coltitle=black}% 제목 글씨색 - 검정
% 문제번호 저장용 매크로
\newcommand{\QuestionNumberumber}{0}% 초기값 0으로 설정
\newcommand{\QuestionNumber}[1]{%
  \renewcommand{\QuestionNumberumber}{\unskip#1\unskip}% 공백 무시, pn값을 저장
  \xdef\lastboxtype{question}%
  \xdef\lastboxno{\QuestionNumberumber}}%
% 환경 시작 시점에도 solbox 추적값 갱신
\NewDocumentEnvironment{questionbox}{g}{%
  \xdef\lastboxtype{question.}%
  \xdef\lastboxno{\thechapter. \QuestionNumberumber}%
  \begin{questionboxbox}{#1}}{\end{questionboxbox}}%

%% problembox 정의
\NewTColorBox{problemboxbox}{g}{boxbase,
  title={\boxtitle{problem\IfNoValueF{#1}{. \,\,#1}}},
  colframe=black,% 테두리(기본 제목 배경) - 검정
  coltitle=white}% 제목 글씨색 - 흰색
  
% 문제번호 저장용 매크로
\newcommand{\ProblemNumberumber}{0}% 초기값 0으로 설정
% 번호 저장 + solbox 추적값 갱신
\newcommand{\ProblemNumber}[1]{%
  \renewcommand{\ProblemNumberumber}{\unskip#1\unskip}% 공백 무시, pn값을 저장
  \xdef\lastboxtype{problem}%
  \xdef\lastboxno{\ProblemNumberumber}}%
% 환경 시작 시점에도 solbox 추적값 갱신
\NewDocumentEnvironment{problembox}{g}{%
  \xdef\lastboxtype{problem.}%
  \xdef\lastboxno{\thechapter. \ProblemNumberumber}%
  \begin{problemboxbox}{#1}}{\end{problemboxbox}}%

% 솔루션 하이라이트, solight - 모드가 3 이상일때만 orange 출력
\newcommand{\soli}[1]{%
  \ifnum\seolmode>2 \hlo{#1}
  \else \hlp{#1} \fi}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% seolmode와 호환되는 박스로 썼으나 이제 안씀. 저장
%% solbox 정의 - 솔루션
% seolmode가 3,4일때만 출력하고 1,2일때는 사라짐
% \ifnum\seolmode>2% seolmode가 3이상이면 출력
%\NewTColorBox{solsolbox}{g}{boxbase,
%  title={\boxtitle{Solution\IfNoValueF{#1}{. \,\,#1}}},
%  colframe=blue!50,% 중간 파란 테두리
%  coltitle=black,% 제목 글씨색
%  colbacktitle=white}% 제목 배경색
% 모드 변경용 하얀박스 - 위의 solsolbox와 완전 똑같이 만들고 전부 흰색으로 처리함
%\NewTColorBox{whitesolsolbox}{g}{boxbase, 
%  title={\boxtitle{\textcolor{white}{Solution\IfNoValueF{#1}{. \,\,#1}}}},
%  colframe=white, coltitle=white,colbacktitle=white}
% 환경정의
%\NewDocumentEnvironment{solbox}{g}{
%  \ifnum\seolmode>2
%    \begin{solsolbox}{#1}
%  \else\begin{whitesolsolbox}{#1}\color{white}\fi}{
%  \ifnum\seolmode>2
%    \end{solsolbox}
%  \else\end{whitesolsolbox}\fi}
