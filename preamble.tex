%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 모든 패키지, 사용자 정의 매크로 호출 
% 호출 경로는 컴파일이 일어나는 main 기준으로 두 단계 올라가서 다시 내려옴
% 기본 골격
\input{../../structure/package.sty}
\input{../../structure/format.sty}
\input{../../structure/page.sty}
% 응용함수
\input{../../structure/seolmode.sty}
\input{../../structure/box.sty}
\input{../../structure/tablefigure.sty}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 페이지 설정
\newcommand{\geoTop}   {20mm} % 위쪽 여백
\newcommand{\geoBottom}{20mm} % 아래 여백
\newcommand{\geoLeft}  {20mm} % 좌측 여백
\newcommand{\geoRight} {20mm} % 우측 여백
\geometry{a4paper, % 기본용지 설정. 위의 숫자만 바꾸면 됨.
top=\geoTop, bottom=\geoBottom, left=\geoLeft, right=\geoRight}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 경고 무시
\hbadness=10000 % underfull hbox 경고 무시(수평 방향 여백 경고 badness 10000까지 무시)
\vbadness=10000 % overfull hbox 경고 무시(수직 방향 페이니 나눔 단락 경고 badness 10000까지 무시)
\hfuzz=7pt  % 7pt 이하의 overfull \hbox 경고 무시


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% main.tex 명령어 단순화
% 제목, 서문, 목차 불러오는 함수 만들기
\newcommand{\includeHead}[1]{\input{../includes/#1.tex}} % 경로 확인할 것

% 참고문헌 불러오기
\newcommand{\setupBib}{ % 참고문헌 있는 경우 불러오기
  \usepackage[backend=biber, style=numeric, sorting=none]{biblatex}
  \usepackage{csquotes}
  \addbibresource{../bib/papers.bib}
  \addbibresource{../bib/references.bib}
  \addbibresource{../bib/websites.bib}}
\newcommand{\printBib}{ % sloppy로 참고문헌 출력시 길이가 길다면 강제 줄바꿈
  \begin{sloppypar} \printbibliography \end{sloppypar}}

% 챕터 불러오기 - 이거 안쓰기로 함. 저장으로 컴파일이 안되는 문제 발생함
\newcommand{\loadchapter}[1]{\subimport{../chapters/#1/}{chapter.tex}}
% 히든 챕터 불러오기 - 본문에 안쓰는 챕터지만 식 참조 위하여 외부참조하기 위함 (aux 파일 한 번 컴파일 해야 함)
\newcommand{\hiddenchapter}[1]{%
  \externaldocument[]{../chapters/#1/chapter}}

  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 캡션, 링크
\renewcommand{\equationautorefname}{Eq.} % 수식 참조 시 equation이 아닌 Eq. 로 나옴. aliascnt 필요
\renewcommand{\figureautorefname}{Fig.} % figure는 Fig
\renewcommand{\tableautorefname}{Table.} % table은 Table 그대로
\captionsetup[figure]{name=Fig.} % 그림 아래 캡션도 Fig. 으로 나오도록 함. caption 필요

\DeclareCaptionFont{mycaptionfont}{\fontsize{8pt}{9pt}\selectfont} % 폰트 크기와 위아래 여백
\captionsetup[figure]{font=mycaptionfont}
\captionsetup[table]{font=mycaptionfont}
\captionsetup[figure]{width=0.8\linewidth} % 캡션 너비 조절 - 본문 너비의 80%로 고정
\captionsetup[table]{width=0.8\linewidth}

\numberwithin{equation}{section} % eq, figure, table이 표시되는 것을 section까지 설정함. 설정하지 않으면 18.1처럼 chapter 별로 정리됨
\numberwithin{figure}{section}
\numberwithin{table}{section}

\AtBeginDocument{ % 다른 설정으로 바뀌지 않도록 고정해버림
% 캡션
\setlength{\abovecaptionskip}{3pt}  % 캡션 위 간격 - 캡션이 위에 있으면 캡션과 그림 사이 간격
\setlength{\belowcaptionskip}{0pt}  % 캡션 아래 간격

% 수식
\setlength{\abovedisplayskip}{5pt}      % 일반적인 디스플레이 수식 위쪽 간격, 모두 0이면 본문과 똑같이 모두 붙음
\setlength{\belowdisplayskip}{5pt}      % 일반적인 디스플레이 수식 아래쪽 간격
\setlength{\abovedisplayshortskip}{5pt} % 특수상황(수식 앞줄이 짧게 끝나는 경우)
\setlength{\belowdisplayshortskip}{5pt} % 특수상황(수식 아랫줄이 짧게 끝나는 경우)

% 본문 포함(인라인)
\setlength{\lineskiplimit}{3pt}         % 인라인 모드 한계치(줄높이가 baselineskip보다 얼마나 부족한가)
\setlength{\lineskip}{3pt}              % 한계치보다 부족한 경우 추가 여유 간격
} % 0pt로 하면 모두 붙어버림, 아래 두줄의 인라인은 본문에도 해당됨

% 문제 풀이시 1값을 주면 문제가 출력되고, 0값을 주면 문제가 출력되지 않음
\newcommand{\qblock}[2]{\ifnum #1 = 1\relax #2 \fi}



\usepackage{tikz}
\usepackage{tikzpagenodes} % current page.* 앵커
\usepackage{caption}
\usepackage{ifoddpage}
% \usepackage{xfp} % \fpeval 쓰면 필요

% 종이(페이지) 경계 기준 데드라인. 0pt=종이 끝이 데드라인.
\newlength\EFTopOffset     \setlength{\EFTopOffset}{0pt}    % 위: (current page.north) - EFTopOffset
\newlength\EFBottomOffset  \setlength{\EFBottomOffset}{0pt} % 아래: (current page.south) + EFBottomOffset

% 내부 상태
\newsavebox{\EFbox}                 % 측정용 박스
\newlength\EFhalf                   % 실제 박스 절반 높이
\newlength\EFy \newlength\EFN \newlength\EFS \newlength\EFyshift
\newlength\EFbottom \newlength\EFtop
\newlength\EFsouthline \newlength\EFnorthline

% (1) 실제 박스 높이 측정 → 절반을 \EFhalf에 저장
%     #1: "그림+캡션" 전체 내용
\newcommand{\EFMeasure}[1]{%
  \sbox{\EFbox}{#1}%
  \setlength{\EFhalf}{.5\dimexpr \ht\EFbox+\dp\EFbox\relax}%
}

% (2) y-클램프: 박스 아래/위 엣지가 종이 데드라인을 넘치면 '넘친 만큼만' 보정
%     #1: 기준 좌표 이름(예: edgefiguremark-<번호>)
\newcommand{\EFClampY}[1]{%
  \setlength{\EFyshift}{0pt}% 기본: 이동 없음
  % 현재 중심 y와 종이 위/아래 경계
  \tikz[remember picture,overlay]{%
    \pgfextracty{\EFy}{\pgfpointanchor{#1}{center}}%
    \pgfextracty{\EFN}{\pgfpointanchor{current page}{north}}%
    \pgfextracty{\EFS}{\pgfpointanchor{current page}{south}}%
  }%
  % 박스 엣지와 데드라인
  \setlength{\EFbottom}{\dimexpr \EFy - \EFhalf\relax}%
  \setlength{\EFtop}{\dimexpr \EFy + \EFhalf\relax}%
  \setlength{\EFsouthline}{\dimexpr \EFS + \EFBottomOffset\relax}%
  \setlength{\EFnorthline}{\dimexpr \EFN - \EFTopOffset\relax}%
  % 아래 넘침 → 위로(+), 위 넘침 → 아래로(−) — 필요한 만큼만
  \ifdim \EFbottom<\EFsouthline
    \setlength{\EFyshift}{\dimexpr \EFsouthline - \EFbottom\relax}%
  \else\ifdim \EFtop>\EFnorthline
    \setlength{\EFyshift}{\dimexpr \EFnorthline - \EFtop\relax}%
  \fi\fi
}